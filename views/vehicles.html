<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CA2 | Vehicles</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="dist/css/skins/skin-blue.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Font -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
  </head>
  <!--
  BODY TAG OPTIONS:
  =================
  Apply one or more of the following classes to get the
  desired effect
  |---------------------------------------------------------|
  | SKINS         | skin-blue                               |
  |               | skin-black                              |
  |               | skin-purple                             |
  |               | skin-yellow                             |
  |               | skin-red                                |
  |               | skin-green                              |
  |---------------------------------------------------------|
  |LAYOUT OPTIONS | fixed                                   |
  |               | layout-boxed                            |
  |               | layout-top-nav                          |
  |               | sidebar-collapse                        |
  |               | sidebar-mini                            |
  |---------------------------------------------------------|
  -->
  <body class="hold-transition skin-blue sidebar-collapse">
    <div class="wrapper">
      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
          <h1>CA2 <small>Vehicles</small></h1>
        </section>

        <!-- Main content -->
        <section class="content container-fluid">
          <div class="row">
            <div class="col-sm-12">
              <div class="box">
                <div class="box-header">
                  <h3 class="box-title">Vehicles (<span id="vehicles_count">?</span>)</h3>
                  <a href="#" class="btn btn-success btn-s" style="float: right;" onclick="createVehicle();">
                    <i class="fa fa-plus"></i>
                  </a>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                  <div id="vehicles_datatable" class="dataTables_wrapper form-inline dt-bootstrap">
                    <div class="row">
                      <div class="col-sm-6"></div>
                      <div class="col-sm-6"></div>
                    </div>
                    
                    <div class="row">
                      <div class="col-sm-12">
                        <table class="table table-bordered table-hover dataTable" role="grid" aria-describedby="example2_info">
                          <thead>
                            <tr role="row">
                              <th tabindex="0" rowspan="1" colspan="1">Type</th>
                              <th tabindex="0" rowspan="1" colspan="1">Manufacturer</th>
                              <th tabindex="0" rowspan="1" colspan="1">Model</th>
                              <th tabindex="0" rowspan="1" colspan="1">Vehicle Year</th>
                              <th tabindex="0" rowspan="1" colspan="1">Value</th>
                              <th tabindex="0" rowspan="1" colspan="1">Quantity</th>
                              <th tabindex="0" rowspan="1" colspan="1">Actions</th>
                            </tr>
                          </thead>
                          
                          <tbody id="vehicles">
                            <tr><td colspan="6" style="text-align: center;">Not Found</td></tr>
                          </tbody>

                          <tfoot>
                            <tr role="row">
                              <th rowspan="1" colspan="1">Type</th>
                              <th rowspan="1" colspan="1">Manufacturer</th>
                              <th rowspan="1" colspan="1">Model</th>
                              <th rowspan="1" colspan="1">Vehicle Year</th>
                              <th rowspan="1" colspan="1">Value</th>
                              <th rowspan="1" colspan="1">Quantity</th>
                              <th rowspan="1" colspan="1">Actions</th>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>
                </div>
                <!-- /.box-body -->
              </div>
            </div>
          </div>
        </section>
        <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->
    </div>
    <!-- ./wrapper -->

    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal" style="display: none;" id="modal_show">
      Launch Default Modal
    </button>

    <div class="modal fade in" id="modal" style="padding-right: 17px;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">Ã—</span>
            </button>
            <h4 class="modal-title" id="modal_title">Default Modal</h4>
          </div>
          <div class="modal-body">
            <form role="form" id="vehicle_form">
              <input type="hidden" name="id" id="vehicle_id"/>
              
              <div class="form-group">
                <label for="vehicle_type">Type</label>
                <select class="form-control" name="type" id="vehicle_type" required>
                  <option value="">Select</option>
                  <option value="Car">Car</option>
                  <option value="Motorcycle">Motorcycle</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="vehicle_manufacturer">Manufacturer</label>
                <input type="text" class="form-control" name="manufacturer" id="vehicle_manufacturer" required/>
              </div>
              
              <div class="form-group">
                <label for="vehicle_model">Model</label>
                <input type="text" class="form-control" name="model" id="vehicle_model" required/>
              </div>
              
              <div class="form-group">
                <label for="vehicle_year">Vehicle Year</label>
              <input type="text" class="form-control" name="vehicle_year" id="vehicle_year" required/>
              </div>
              
              <div class="form-group">
                <label for="vehicle_value">Value</label>
                <input type="text" class="form-control" name="value" id="vehicle_value" required/>
              </div>
              
              <div class="form-group">
                <label for="vehicle_quantity">Quantity</label>
                <input type="text" class="form-control" name="quantity" id="vehicle_quantity" required/>
              </div>

              <input type="submit" id="vehicle_form_submit" style="display: none;"/>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal" id="modal_close">Close</button>
            <button type="button" class="btn btn-success" id="modal_save" onclick="vehicle_form_submit.click();">Save changes</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
  </body>

  <!-- REQUIRED JS SCRIPTS -->

  <!-- jQuery 3 -->
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <!-- Bootstrap 3.3.7 -->
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <!-- AdminLTE App -->
  <script src="dist/js/adminlte.min.js"></script>

  <script src="bower_components/inputmask/dist/inputmask/inputmask.js"></script>
  <script src="bower_components/inputmask/dist/inputmask/jquery.inputmask.js"></script>

  <script>
    window.onload = function() {
      $('#vehicle_manufacturer').inputmask({regex: '[a-zA-Z0-9 ]+'});
      $('#vehicle_model').inputmask({regex: '[a-zA-Z0-9 ]+'});
      $('#vehicle_year').inputmask({regex: '[0-9]{4}'});
      $('#vehicle_value').inputmask({regex: '[0-9]{1,9}([.][0-9][0-9]?)?'});
      $('#vehicle_quantity').inputmask({regex: '[0-9]{1,9}'});

      showVehicles();
    }

    vehicle_form.onsubmit = function() {
      switch (this.route) {
        case 'update': updateVehicle(); break;
        case 'add': addVehicle(); break;
      }

      return false;
    }

    function showVehicles() {
      $.ajax({
        url: "/vehicle",
        method: 'get',
        //data: $(this).serialize(),
        //dataType: "json",
        contentType: "application/json; charset=utf-8",
        beforeSend: function() {
          vehicles.innerHTML = '';
        },
        success: function(response) {
          try  {
            if ('vehicles' in response) {
              if (response.vehicles.length > 0) {
                vehicles_count.innerHTML = response.vehicles.length;
                
                response.vehicles.forEach(vehicle => {
                    vehicles.innerHTML += '<tr>';

                    vehicles.innerHTML += 
                      '<td>' + vehicle.type +'</td>' +
                      '<td>' + vehicle.manufacturer +'</td>' +
                      '<td>' + vehicle.model +'</td>' +
                      '<td>' + vehicle.vehicle_year +'</td>' +
                      '<td>' + vehicle.value +'</td>' +
                      '<td>' + vehicle.quantity +'</td>' +
                      '<td>' +
                        '<div class="btn-group">' +
                        '<a href="#" class="btn btn-default btn-xs" onclick="showVehicle(\'' + vehicle._id + '\', true);">' + 
                            '<i class="fa fa-eye"></i>' + 
                          '</a>' + 
                          
                          '<a href="#" class="btn btn-default btn-xs" onclick="showVehicle(\'' + vehicle._id + '\', false);">' +
                            '<i class="fa fa-edit"></i>' + 
                          '</a>' +

                          '<a href="#" class="btn btn-danger btn-xs" onclick="if (confirm(\'Are you sure you want to delete this vehicle?\')) {deleteVehicle(\'' + vehicle._id + '\');}">' +
                            '<i class="fa fa-trash"></i>' + 
                          '</a>' +
                        '</div>' +
                      '</td>';

                    vehicles.innerHTML += '</tr>';
                });
              }
              else {
                vehicles_count.innerHTML = response.vehicles.length;
                vehicles.innerHTML = '<tr><td colspan="6" style="text-align: center;">Not Found</td></tr>';
              }
            }
          }
          catch (exe) {
            console.log(exe.message);
            vehicles.innerHTML = '<tr><td colspan="6" style="text-align: center;">Not Found</td></tr>';
          }
        },
        error: function(error) {
          console.log(error);
          vehicles.innerHTML = '<tr><td colspan="6" style="text-align: center;">Not Found</td></tr>';
        },
        complete: function() {}
      });
    }

    function showVehicle(_vehicle_id, _readonly = true) {
      $.ajax({
        url: "/vehicle/" + _vehicle_id,
        method: 'get',
        //data: $(this).serialize(),
        //dataType: "json",
        contentType: "application/json; charset=utf-8",
        beforeSend: function() {
          vehicle_form.reset();
          
          if (_readonly) {
            vehicle_type.setAttribute('disabled', true);
            vehicle_manufacturer.setAttribute('readonly', true);
            vehicle_model.setAttribute('readonly', true);
            vehicle_year.setAttribute('readonly', true);
            vehicle_value.setAttribute('readonly', true);
            vehicle_quantity.setAttribute('readonly', true);
          }
          else {
            vehicle_form.route = 'update';

            vehicle_type.removeAttribute('disabled');
            vehicle_manufacturer.removeAttribute('readonly');
            vehicle_model.removeAttribute('readonly');
            vehicle_year.removeAttribute('readonly');
            vehicle_value.removeAttribute('readonly');
            vehicle_quantity.removeAttribute('readonly');
          }
        },
        success: function(response) {
          try {
            if ('vehicle' in response) {
              if (_readonly) {
                modal_title.innerHTML = 'Show Vehicle';
                modal_save.style.display = 'none';
              }
              else {
                modal_title.innerHTML = 'Edit Vehicle';
                modal_save.style.display = 'inline-block';
              }
                
              vehicle = response.vehicle;

              vehicle_id.value = vehicle._id;
              
              vehicle_type.value = vehicle.type;
              vehicle_manufacturer.value = vehicle.manufacturer;                
              vehicle_model.value = vehicle.model;                
              vehicle_year.value = vehicle.vehicle_year;                
              vehicle_value.value = vehicle.value;                
              vehicle_quantity.value = vehicle.quantity;

              modal_show.click();
            }
          }
          catch (exe) {
            console.log(exe.message);
          }
        },
        error: function(error) {
          console.log(error);
        },
        complete: function() {}
      });
    }

    function updateVehicle() {
      $.ajax({
        url: "/vehicle/" + vehicle_id.value,
        method: 'put',
        data: JSON.stringify({
          type: vehicle_type.value, 
          manufacturer: vehicle_manufacturer.value, 
          model: vehicle_model.value,
          vehicle_year: vehicle_year.value,
          value: vehicle_value.value, 
          quantity: vehicle_quantity.value
        }),
        //dataType: "json",
        contentType: "application/json; charset=utf-8",
        beforeSend: function() {
          modal_save.disabled = true;
        },
        success: function(response) {
          try {
            if ('vehicle' in response) {
              vehicle = response.vehicle;

              vehicle_id.value = vehicle._id;
              
              vehicle_type.value = vehicle.type;
              vehicle_manufacturer.value = vehicle.manufacturer;                
              vehicle_model.value = vehicle.model;                
              vehicle_year.value = vehicle.vehicle_year;                
              vehicle_value.value = vehicle.value;                
              vehicle_quantity.value = vehicle.quantity;

              showVehicles();

              alert('Vehicle successfully changed!');

              modal_close.click();
            }
          }
          catch (exe) {
            console.log(exe.message);
          }
        },
        error: function(error) {
          console.log(error);
        },
        complete: function() {
          modal_save.disabled = false;
        }
      });
    }

    function deleteVehicle(_vehicle_id) {
      $.ajax({
        url: "/vehicle/" + _vehicle_id,
        method: 'delete',
        //data: JSON.stringify(),
        //dataType: "json",
        contentType: "application/json; charset=utf-8",
        beforeSend: function() {},
        success: function(response) {
          try {
            if ('success' in response && response.success) {
              showVehicles();
            }

            if ('message' in response) {
              alert(response.message);
            }
          }
          catch (exe) {
            console.log(exe.message);
          }
        },
        error: function(error) {
          console.log(error);
        },
        complete: function() {}
      });
    }

    function addVehicle() {
      $.ajax({
        url: "/vehicle/",
        method: 'post',
        data: JSON.stringify({
          type: vehicle_type.value, 
          manufacturer: vehicle_manufacturer.value, 
          model: vehicle_model.value,
          vehicle_year: vehicle_year.value,
          value: vehicle_value.value, 
          quantity: vehicle_quantity.value
        }),
        //dataType: "json",
        contentType: "application/json; charset=utf-8",
        beforeSend: function() {
          modal_save.disabled = true;
        },
        success: function(response) {
          try {
            if ('vehicle' in response) {
              vehicle = response.vehicle;

              vehicle_id.value = vehicle._id;
              
              vehicle_type.value = vehicle.type;
              vehicle_manufacturer.value = vehicle.manufacturer;                
              vehicle_model.value = vehicle.model;                
              vehicle_year.value = vehicle.vehicle_year;                
              vehicle_value.value = vehicle.value;                
              vehicle_quantity.value = vehicle.quantity;

              showVehicles();
              
              alert('Vehicle successfully added!');

              modal_close.click();
            }
          }
          catch (exe) {
            console.log(exe.message);
          }
        },
        error: function(error) {
          console.log(error);
        },
        complete: function() {
          modal_save.disabled = false;
        }
      });
    }

    function createVehicle() {
      vehicle_form.route = 'add';
      vehicle_form.reset();

      vehicle_type.removeAttribute('disabled');
      vehicle_manufacturer.removeAttribute('readonly');
      vehicle_model.removeAttribute('readonly');
      vehicle_year.removeAttribute('readonly');
      vehicle_value.removeAttribute('readonly');
      vehicle_quantity.removeAttribute('readonly');

      modal_title.innerHTML = 'Add Vehicle';
      modal_save.style.display = 'inline-block';

      modal_show.click();
    }
  </script>
</html>